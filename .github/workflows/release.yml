name: Release ClipBlock

on:
  push:
    tags:
      - 'v*' # Dispara ao subir tags como v1.0.0
  workflow_dispatch: # Permite rodar manualmente pelo painel do GitHub

permissions:
  contents: write # Essencial para permitir que o bot crie a Release e suba os arquivos

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ¹ Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # VersÃ£o estÃ¡vel compatÃ­vel com Wails v2

      - name: ðŸŸ¢ Configurar Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ”§ Instalar DependÃªncias do Linux
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev build-essential pkg-config

      - name: ðŸ”¨ Instalar Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: ðŸ—ï¸ Compilar ClipBlock
        run: |
          # 1. Garante que as dependÃªncias do Go estÃ£o em ordem
          go mod tidy
          
          # 2. Compila o projeto usando o Wails (Gera o Frontend e o BinÃ¡rio)
          # O parÃ¢metro -o define o nome do arquivo final
          wails build -platform linux/amd64 -tags webkit2_41 -clean -o clip-block

      - name: ðŸ“¦ Preparar Empacotamento
        run: |
          # Cria a estrutura de pastas para o tar.gz
          mkdir -p dist/bin
          
          # O Wails por padrÃ£o coloca o binÃ¡rio em build/bin/
          if [ -f "build/bin/clip-block" ]; then
            cp build/bin/clip-block dist/bin/
          else
            # Caso o Wails tenha gerado na raiz por causa do parÃ¢metro -o
            cp clip-block dist/bin/
          fi
          
          # Copia o script de instalaÃ§Ã£o para a raiz do pacote
          cp scripts/install.sh dist/
          
          # Garante que tudo tenha permissÃ£o de execuÃ§Ã£o
          chmod +x dist/install.sh
          chmod +x dist/bin/clip-block
          
          # Define variÃ¡veis para o nome do arquivo
          ARCH="amd64"
          FILENAME="clip-block_linux_${ARCH}.tar.gz"
          
          # Compacta o conteÃºdo da pasta dist
          cd dist
          tar -czf ../$FILENAME *
          
          # Exporta o caminho para os prÃ³ximos steps
          echo "ASSET_NAME=$FILENAME" >> $GITHUB_ENV
          echo "ASSET_PATH=$FILENAME" >> $GITHUB_ENV

      - name: ðŸš€ Criar Release no GitHub
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ASSET_PATH }}
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref }}
          generate_release_notes: true
          draft: false
          prerelease: false